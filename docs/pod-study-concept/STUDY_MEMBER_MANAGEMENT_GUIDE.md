# [v2] 스터디 멤버 관리: 역할, 책임, 보안 설계 가이드

## 1. 개요

본 문서는 스터디 멤버십 관리 기능과 관련된 역할, 책임, 그리고 보안 아키텍처를 정의합니다. 주요 논의점은 다음과 같습니다.

- 스터디 생성과 멤버 가입이라는 두 가지 핵심 플로우에서 **승인 주체**를 누구로 할 것인가? (어드민 vs 스터디 리더)
- 각 승인 행위는 어느 플랫폼에서 이루어져야 하는가? (`web` vs `backoffice`)
- 프론트엔드에서의 역할(Role) 값 조작 가능성에 어떻게 대비하고 안전한 아키텍처를 구축할 것인가?

## 2. 역할 및 책임(R&R) 정의

서비스의 확장성과 사용자 경험을 고려하여, 승인 흐름을 **스터디 개설**과 **멤버 참여** 두 가지로 명확히 분리하고 각기 다른 주체에게 권한을 부여합니다.

| 구분 | 주체 (Actor) | 행위 (Action) | 플랫폼 (Platform) | 목적 |
| :--- | :--- | :--- | :--- | :--- |
| **스터디 개설** | 스터디 리더 | 스터디 개설 신청 | `web` | 새로운 스터디 생성을 요청 |
| | **어드민** | 개설 신청 승인/반려 | `study-platform-backoffice` | 플랫폼의 품질 관리 및 기준 검토 |
| **멤버 참여** | 일반 사용자 | 스터디 참여 신청 | `web` | 기존 스터디에 멤버로 합류 요청 |
| | **스터디 리더** | 참여 신청 승인/반려 | `web` | 스터디의 목적에 맞는 멤버 선발 |

### 왜 이렇게 설계하는가?

- **권한과 책임의 일치:** 플랫폼 전체를 관리하는 **어드민**은 스터디 개설 승인과 같은 거시적인 관리를, 스터디의 성공을 책임지는 **리더**는 멤버 선발과 같은 미시적인 운영을 담당하는 것이 합리적입니다.
- **확장성:** 모든 멤버 승인을 어드민이 담당할 경우 발생하는 병목 현상을 방지하고, 승인 책임이 각 리더에게 분산되어 서비스가 성장하더라도 유연하게 대처할 수 있습니다.
- **사용자 경험(UX):** 리더가 멤버 관리를 위해 별도의 백오피스에 접근할 필요 없이, 주 사용 공간인 `web` 애플리케이션 내에서 모든 스터디 운영 활동을 완결할 수 있습니다.

## 3. 보안 아키텍처: 안전한 권한 처리

프론트엔드에서의 역할(Role) 값은 신뢰할 수 없다는 원칙(Never trust the client) 하에, 모든 핵심 권한 검증은 백엔드에서 수행합니다.

### 3.1. 전체 인증/인가 흐름

사용자가 로그인해서 리더 전용 기능을 사용하기까지의 전체 흐름은 다음과 같습니다.

1.  **로그인 및 토큰 발급:**
    -   사용자가 `web`에서 로그인하면, `user-service`는 인증 성공 후 **Role 정보 (`ROLE_LEADER` 등)가 포함된 JWT를 생성하여 서명**하고 클라이언트에게 전달합니다.

2.  **프론트엔드 UI 렌더링:**
    -   `web`은 JWT의 정보를 바탕으로 리더에게만 '멤버 관리' 버튼 등을 노출시킵니다. 이는 순수한 **UX 편의 기능**이며 보안과는 무관합니다.

3.  **API 요청 (리더의 액션):**
    -   리더가 '멤버 승인' 버튼을 클릭하면, `web`은 다음과 같이 JWT를 포함하여 API를 호출합니다.
    ```
    POST /api/studies/{studyId}/members/{userId}/approve
    Authorization: Bearer <SIGNED_JWT_TOKEN>
    ```

4.  **백엔드 권한 검증 (2단계):**
    -   백엔드는 2단계에 걸쳐 요청의 유효성과 권한을 철저히 검증합니다. 이 과정 중 하나라도 실패하면 요청은 즉시 거부됩니다.

### 3.2. 백엔드 검증 상세 다이어그램

다음은 백엔드에서 이루어지는 2단계 검증 과정을 시각적으로 표현한 것입니다.

```mermaid
sequenceDiagram
    participant Client(web)
    participant Gateway(core-platform)
    participant StudyService(study-service)
    participant DB

    Client->>+Gateway: POST /api/studies/... (JWT 포함)
    Note over Gateway: 1단계: 토큰 유효성 검증
    Gateway->>Gateway: JWT 서명(Signature) 검증
    alt 서명 유효하지 않음
        Gateway-->>-Client: 401 Unauthorized 응답
    else 서명 유효
        Gateway->>+StudyService: 요청 전달 (사용자 정보 포함)
        Note over StudyService: 2단계: 비즈니스 권한 검증
        StudyService->>+DB: 이 사용자가 해당 스터디의 리더인지 확인
        DB-->>-StudyService: 리더 정보 반환
        alt 리더 아님
            StudyService-->>-Client: 403 Forbidden 응답
        else 리더 맞음
            StudyService->>StudyService: 멤버 승인 로직 수행
            StudyService-->>-Client: 200 OK 응답
        end
    end
```

### 3.3. 백엔드 검증 단계별 설명

#### 1단계: API 게이트웨이 - 토큰 유효성 검증
- **주체:** `core-platform`의 API 게이트웨이
- **역할:** 시스템의 첫 번째 방어선으로서, 모든 수신 요청의 `Authorization` 헤더를 확인합니다.
- **검증 내용:** 서버의 비밀 키를 사용하여 JWT의 서명이 위조되지 않았는지 확인합니다.
- **실패 시:** 서명이 유효하지 않으면, 이는 위조된 토큰으로 간주하여 요청을 즉시 **401 Unauthorized**로 거부합니다. 이 요청은 백엔드 서비스에 도달하지 못합니다.

#### 2단계: 백엔드 서비스 - 비즈니스 권한 검증
- **주체:** `study-service`
- **역할:** 토큰이 유효하다고 해서 해당 리소스에 대한 권한이 있다고 보장할 수 없습니다. 따라서 실제 비즈니스 로직 상의 권한을 한번 더 확인합니다.
- **검증 내용:** 게이트웨이에서 전달받은 신뢰할 수 있는 사용자 ID가 **요청된 스터디의 실제 리더가 맞는지** 데이터베이스 조회를 통해 확인합니다.
- **실패 시:** 사용자가 다른 스터디의 리더이거나 일반 사용자일 경우, **403 Forbidden**을 반환하여 접근을 거부합니다.

## 4. 프론트엔드 보안 강화 (권장 사항)

악의적인 사용자가 프론트엔드 코드를 조작하여 리더 전용 페이지(e.g., `/manage-study`)로 직접 접근하는 경우를 방지하기 위해 다음과 같이 설계합니다.

1.  해당 페이지에 진입하는 즉시, 페이지에 필요한 데이터(e.g., 신청자 목록)를 가져오는 API를 호출합니다.
2.  백엔드는 권한 없는 사용자의 요청에 대해 `403 Forbidden` 에러를 반환합니다.
3.  프론트엔드는 이 에러를 감지하여, 사용자에게 "권한이 없습니다" 메시지를 보여주거나 홈페이지로 리다이렉트 시킵니다.

이러한 설계를 통해, 권한 없는 사용자는 리더용 페이지의 **레이아웃(껍데기)조차 볼 수 없게 되어** 더욱 안전하고 견고한 사용자 경험을 제공할 수 있습니다.

## 5. 최종 요약

- **역할 분담:** 플랫폼 관리는 **어드민**이, 개별 스터디 운영은 **리더**가 담당합니다.
- **신뢰 주체:** 프론트엔드는 UX만 담당하며, 모든 데이터와 권한의 신뢰 지점(Source of Truth)은 **백엔드**입니다.
- **다단계 검증:** 백엔드는 **①토큰 자체의 유효성(인증)**과 **②리소스 접근 권한(인가)**을 모두 검증하여 보안을 강화합니다.
- **UI 처리:** 권한 없는 사용자가 제한된 페이지의 **레이아웃(껍데기)조차 볼 수 없도록**, 페이지 진입 시 데이터 조회 API의 응답 코드를 확인하여 리다이렉트 처리하는 것이 가장 안전합니다.