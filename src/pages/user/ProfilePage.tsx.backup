import React, { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';
import Header from '../../components/layout/Header';
import PasswordChangeModal from '../../components/auth/PasswordChangeModalEnhanced';
import LogoutConfirmModal from '../../components/auth/LogoutConfirmModal';
import gameActivityService, { GameActivity } from '../../services/gameActivityService';
import StarBackground from '../../components/common/StarBackground';
import './ProfilePage.css';
import studyService, { ApplicationStatus, type MyApplicationItem } from '../../api/studyService';
import reviewService from '../../api/reviewService';
import { handleApiError } from '../../api/client';

function ProfilePage(): React.ReactNode {
  // Auth context에서 실제 사용자 정보 가져오기
  const { user: authUser, isAuthenticated, isLoading } = useAuth();
  const navigate = useNavigate();
  
  // Debug: Check user roles
  useEffect(() => {
    if (authUser) {
      console.log('=== ProfilePage Debug ===');
      console.log('User:', authUser);
      console.log('SystemRole:', authUser.systemRole);
      console.log('Roles:', authUser.roles);
      console.log('Is Admin:', authUser?.systemRole === 'ROLE_ADMIN');
      console.log('========================');
    }
  }, [authUser]);
  
  // 인증되지 않은 경우 로그인 페이지로 리디렉션
  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      navigate('/login', { replace: true });
    }
  }, [isAuthenticated, isLoading, navigate]);
  
  // 탭 상태 관리
  const [activeTab, setActiveTab] = useState<'study' | 'game'>('study');
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  const [showLogoutModal, setShowLogoutModal] = useState(false);
  const [gameActivities, setGameActivities] = useState<GameActivity[]>([]);
  const [gameSummary, setGameSummary] = useState<{
    totalGames: number;
    totalWins: number;
    favoriteGame?: string;
    lastActivity?: string;
  }>({ totalGames: 0, totalWins: 0 });

  // 사용자 정보 (authUser가 있으면 실제 데이터 사용)
  const user = {
    name: authUser?.name || authUser?.username || '사용자',
    profileImage: authUser?.profileImage || null,
    joinedDays: authUser?.createdAt 
      ? Math.floor((Date.now() - new Date(authUser.createdAt).getTime()) / (1000 * 60 * 60 * 24))
      : 0,
  };

  // 게임 활동 데이터 로드
  useEffect(() => {
    const loadGameData = async () => {
      const userId = authUser?.email || authUser?.username || authUser?.name;
      const activities = await gameActivityService.getGameActivities(userId);
      const summary = await gameActivityService.getGameSummary(userId);
      
      setGameActivities(activities);
      setGameSummary(summary);
    };
    
    loadGameData();
  }, [authUser]);

  // 나의 스터디 데이터
  const [myStudies, setMyStudies] = useState<{ participating: any[]; leading: any[] }>({ participating: [], leading: [] });
  const [myApplications, setMyApplications] = useState<MyApplicationItem[]>([]);
  const [studiesLoading, setStudiesLoading] = useState<boolean>(true);
  const [studiesError, setStudiesError] = useState<string | null>(null);
  const [applicationsLoading, setApplicationsLoading] = useState<boolean>(true);
  const [applicationsError, setApplicationsError] = useState<string | null>(null);
  const [studyReviews, setStudyReviews] = useState<Record<string, boolean>>({});
  const [applicationFilter, setApplicationFilter] = useState<'ALL' | ApplicationStatus>(ApplicationStatus.PENDING);
  const [participatingCollapsed, setParticipatingCollapsed] = useState<boolean>(true);
  const [leadingCollapsed, setLeadingCollapsed] = useState<boolean>(true);

  useEffect(() => {
    // Set initial collapsed state responsively: desktop expanded, mobile collapsed
    try {
      const isDesktop = typeof window !== 'undefined' && window.innerWidth >= 1024;
      setParticipatingCollapsed(!isDesktop);
      setLeadingCollapsed(!isDesktop);
    } catch {}

    const loadMyStudies = async () => {
      try {
        setStudiesLoading(true);
        const list = await studyService.getMyMemberships();
        console.log('My studies list:', list);
        const participating = list.filter(item => item.role !== 'OWNER');
        const leading = list.filter(item => item.role === 'OWNER');
        setMyStudies({ participating, leading });
        
        // 각 스터디별 리뷰 작성 여부 확인
        try {
          const myReviews = await reviewService.getMyReviews();
          console.log('=== Review Debug ===');
          console.log('My reviews:', myReviews);
          console.log('Participating studies:', participating.map(s => ({ studyId: s.studyId, title: s.studyTitle })));
          const reviewedStudies: Record<string, boolean> = {};
          myReviews.forEach((review: any) => {
            console.log(`Review type: ${review.type}, studyId: ${review.studyId}`);
            if (review.type === 'STUDY_EXPERIENCE') {
              reviewedStudies[review.studyId] = true;
            }
          });
          console.log('Reviewed studies map:', reviewedStudies);
          console.log('===================');
          setStudyReviews(reviewedStudies);
        } catch (error) {
          console.error('Failed to fetch reviews:', error);
          // 리뷰 조회 실패해도 계속 진행
        }
      } catch (e: any) {
        console.error('Failed to load studies:', e);
        setStudiesError(handleApiError(e));
      } finally {
        setStudiesLoading(false);
      }
    };
    const loadMyApplications = async () => {
      try {
        setApplicationsLoading(true);
        const apps = await studyService.getMyApplications();
        setMyApplications(apps);
      } catch (e: any) {
        setApplicationsError(handleApiError(e));
      } finally {
        setApplicationsLoading(false);
      }
    };
    // 인증 상태가 확정될 때까지 대기
    if (isLoading) return;
    
    // user 존재 여부만 체크 (isAuthenticated는 신뢰할 수 없음)
    if (authUser) {
      loadMyStudies();
      loadMyApplications();
    }
  }, [authUser, isLoading]);

  const greeting = () => {
    const hour = new Date().getHours();
    if (hour < 12) return '좋은 아침이에요';
    if (hour < 18) return '좋은 오후예요';
    return '좋은 저녁이에요';
  };

  return (
    <div className="profile-page">
      {/* 투명 헤더 */}
      <Header transparent />
      
      {/* 별 배경 효과 */}
      <StarBackground />
      
      {(isLoading || !authUser) ? (
        <div className="profile-page-loading">
          <div className="loading-spinner">로딩 중...</div>
        </div>
      ) : (
      <div className="profile-container">
      {/* 프로필 요약 섹션 */}
      <section className="profile-summary">
        <div className="profile-header">
          <div className="profile-image">
            {user.profileImage ? (
              <img src={user.profileImage} alt="프로필" />
            ) : (
              <div className="profile-placeholder">
                {user.name?.[0] || '?'}
              </div>
            )}
            {/* Admin Badge - with unique prefix to avoid conflicts */}
            {(authUser?.systemRole === 'ROLE_ADMIN' || authUser?.roles?.includes('ROLE_ADMIN') || authUser?.roles?.includes('ADMIN')) && (
              <div className="profile-admin-badge" title="AsyncSite Administrator">
                <svg className="profile-admin-icon" viewBox="0 0 24 24" width="18" height="18">
                  <path fill="white" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                </svg>
              </div>
            )}
          </div>
          <div className="profile-info">
            <h1>{greeting()}, {user.name}님!</h1>
            <p className="join-info">AsyncSite와 함께한 지 <span className="highlight">{user.joinedDays}일째</span></p>
          </div>
        </div>
      </section>

      {/* 탭 섹션 컨테이너 */}
      <div className="tab-section-container">
        {/* 탭 네비게이션 */}
        <div className="tab-navigation">
          <button
            className={`tab-button ${activeTab === 'study' ? 'active' : ''}`}
            onClick={() => setActiveTab('study')}
          >
            스터디
          </button>
          <button
            className={`tab-button ${activeTab === 'game' ? 'active' : ''}`}
            onClick={() => setActiveTab('game')}
          >
            게임 활동
          </button>
        </div>

        {/* 탭 콘텐츠 영역 */}
        <div className="tab-content">
        {/* 스터디 탭 콘텐츠 */}
        {activeTab === 'study' && (
          <section className="study-section">
            {/* 신청 내역 섹션 (고유 접두사: myapps-) */}
            <div className="myapps-section">
              <div className="myapps-header">
                <h3 className="myapps-title">신청 내역 <span className="myapps-count-badge">대기 {myApplications.filter(a => a.status === ApplicationStatus.PENDING).length}</span></h3>
                <div className="myapps-filters">
                  {(() => {
                    const counts = {
                      PENDING: myApplications.filter(a => a.status === ApplicationStatus.PENDING).length,
                      ACCEPTED: myApplications.filter(a => a.status === ApplicationStatus.ACCEPTED).length,
                      REJECTED: myApplications.filter(a => a.status === ApplicationStatus.REJECTED).length,
                      ALL: myApplications.filter(a => a.status !== ApplicationStatus.CANCELLED).length,
                    };
                    return ([ApplicationStatus.PENDING, ApplicationStatus.ACCEPTED, ApplicationStatus.REJECTED, 'ALL'] as const).map(key => (
                      <button
                        key={key}
                        className={`myapps-chip ${applicationFilter === key ? 'active' : ''}`}
                        onClick={() => setApplicationFilter(key)}
                      >
                        {key === 'ALL' ? '전체' : key === ApplicationStatus.PENDING ? '대기 중' : key === ApplicationStatus.ACCEPTED ? '승인됨' : '거절됨'}
                        <span className="myapps-chip-count">{counts[key as keyof typeof counts]}</span>
                      </button>
                    ));
                  })()}
                </div>
              </div>

              {applicationsLoading ? (
                <div className="myapps-loading">신청 내역을 불러오는 중…</div>
              ) : applicationsError ? (
                <div className="myapps-empty">
                  <p>신청 내역을 불러오지 못했어요.</p>
                  <p className="error-detail">{applicationsError}</p>
                </div>
              ) : (
                (() => {
                  const base = applicationFilter === 'ALL'
                    ? myApplications.filter(a => a.status !== ApplicationStatus.CANCELLED) // ALL에도 취소는 제외해서 잡음 최소화
                    : myApplications.filter(app => app.status === applicationFilter);
                  const filtered = base
                    .sort((a, b) => new Date(b.appliedAt).getTime() - new Date(a.appliedAt).getTime());

                  if (filtered.length === 0) {
                    return <div className="myapps-empty">{applicationFilter === ApplicationStatus.PENDING ? '대기 중인 신청이 없습니다.' : applicationFilter === ApplicationStatus.ACCEPTED ? '승인된 신청이 없습니다.' : applicationFilter === ApplicationStatus.REJECTED ? '거절된 신청이 없습니다.' : '표시할 신청 내역이 없습니다.'}</div>;
                  }

                  return (
                    <ul className="myapps-list">
                      {filtered.map(app => (
                        <li key={app.applicationId} className={`myapps-item myapps-status-${(app.status || 'PENDING').toLowerCase()}`}>
                          <div className="myapps-main">
                            <div className="myapps-title-line">
                              <span className="myapps-study-title">{app.studyTitle}</span>
                              <span className="myapps-badge">
                                {app.status === ApplicationStatus.PENDING && '대기 중'}
                                {app.status === ApplicationStatus.ACCEPTED && '승인됨'}
                                {app.status === ApplicationStatus.REJECTED && '거절됨'}
                              </span>
                            </div>
                            <div className="myapps-meta">
                              <span>신청일: {new Date(app.appliedAt).toLocaleString()}</span>
                              {app.reviewNote && <span className="myapps-note">메모: {app.reviewNote}</span>}
                            </div>
                          </div>
                          <div className="myapps-actions">
                            {app.status === ApplicationStatus.PENDING ? (
                              <button
                                className="myapps-btn-cancel"
                                onClick={async () => {
                                  try {
                                    await studyService.cancelApplication(app.studyId, app.applicationId, authUser?.email || authUser?.username);
                                    // 낙관적 업데이트
                                    setMyApplications(prev => prev.map(x => x.applicationId === app.applicationId ? { ...x, status: ApplicationStatus.CANCELLED } : x));
                                  } catch (err) {
                                    console.error(err);
                                    alert('신청 취소에 실패했습니다.');
                                  }
                                }}
                              >
                                신청 취소
                              </button>
                            ) : app.status === ApplicationStatus.REJECTED ? (
                              <button
                                className="myapps-btn-reapply"
                                onClick={() => navigate(`/study/${app.studyId}/apply`)}
                              >
                                다시 신청
                              </button>
                            ) : (
                              <button
                                className="myapps-btn-goto"
                                onClick={() => navigate(`/study/${app.studyId}/manage`)}
                              >
                                스터디로 이동
                              </button>
                            )}
                          </div>
                        </li>
                      ))}
                    </ul>
                  );
                })()
              )}
            </div>

            {/* 나의 스터디 섹션 */}
            <h2>나의 스터디</h2>
            {studiesLoading ? (
              <div className="study-loading-inline">스터디 불러오는 중…</div>
            ) : studiesError ? (
              <div className="empty-state">
                <p>스터디 정보를 불러오지 못했어요.</p>
                <p className="error-detail">{studiesError}</p>
                <button className="retry-button" onClick={() => {
                  setStudiesError(null);
                  setStudiesLoading(true);
                  (async () => {
                    try {
                      const list = await studyService.getMyMemberships();
                      const participating = list.filter(item => item.role !== 'OWNER');
                      const leading = list.filter(item => item.role === 'OWNER');
                      setMyStudies({ participating, leading });
                    } catch (err) {
                      setStudiesError(handleApiError(err));
                    } finally {
                      setStudiesLoading(false);
                    }
                  })();
                }}>다시 시도</button>
              </div>
            ) : myStudies.participating.length === 0 && myStudies.leading.length === 0 ? (
              <div className="empty-state">
                <p>아직 참여 중인 스터디가 없어요</p>
                <p>스터디를 둘러보고 관심있는 주제에 참여해보세요!</p>
                <p className="suggestion">게임도 함께 즐기면서 공부하는 건 어떨까요?</p>
                <Link to="/study" className="browse-button">스터디 둘러보기</Link>
              </div>
            ) : (
              <>
                <div className="study-group">
                  <div className="myst-section-header">
                    <h3>참여 중인 스터디 <span className="myst-badge">{myStudies.participating.length}</span></h3>
                    {myStudies.participating.length > 3 && (
                      <button className="myst-toggle" onClick={() => setParticipatingCollapsed(c => !c)}>
                        {participatingCollapsed ? '모두 보기' : '접기'}
                      </button>
                    )}
                  </div>
                  <div className="study-cards">
                    {(participatingCollapsed ? myStudies.participating.slice(0, 3) : myStudies.participating).map(study => (
                      <div key={study.memberId} className="study-card">
                        <h4>
                          {study.studyTitle}
                          {study.studyStatus && (
                            <span className={`study-status-badge study-status-${study.studyStatus.toLowerCase()}`}>
                              {study.studyStatus === 'IN_PROGRESS' ? '진행중' : 
                               study.studyStatus === 'COMPLETED' ? '완료' :
                               study.studyStatus === 'APPROVED' ? '모집중' :
                               study.studyStatus === 'TERMINATED' ? '종료' : study.studyStatus}
                            </span>
                          )}
                        </h4>
                        <p className="study-meta">역할: {study.role}</p>
                        <p className="study-meta">참여일: {new Date(study.joinedAt).toLocaleDateString()}</p>
                        <p className="study-meta">출석률: {study.attendanceRate == null ? 'N/A' : `${study.attendanceRate}%`}</p>
                        {study.studyStatus === 'COMPLETED' && (
                          <div className="study-actions">
                            <button 
                              className="review-action-button"
                              onClick={() => {
                                console.log('Button clicked for study:', study.studyId);
                                console.log('studyReviews state:', studyReviews);
                                console.log('Has review?', studyReviews[study.studyId]);
                                navigate(`/study/${study.studyId}/review/write`);
                              }}
                            >
                              {studyReviews[study.studyId] ? '리뷰 수정' : '리뷰 작성'}
                            </button>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {myStudies.leading.length > 0 && (
                  <div className="study-group">
                    <div className="myst-section-header">
                      <h3>내가 리드하는 스터디 <span className="myst-badge">{myStudies.leading.length}</span></h3>
                      {myStudies.leading.length > 3 && (
                        <button className="myst-toggle" onClick={() => setLeadingCollapsed(c => !c)}>
                          {leadingCollapsed ? '모두 보기' : '접기'}
                        </button>
                      )}
                    </div>
                    <div className="study-cards">
                      {(leadingCollapsed ? myStudies.leading.slice(0, 3) : myStudies.leading).map(study => (
                        <div 
                          key={study.memberId} 
                          className="study-card leading clickable"
                          onClick={() => navigate(`/study/${study.studyId}/manage`)}
                          style={{ cursor: 'pointer' }}
                        >
                          <span className="leader-badge">리더</span>
                          <h4>
                            {study.studyTitle}
                            {study.studyStatus && (
                              <span className={`study-status-badge study-status-${study.studyStatus.toLowerCase()}`}>
                                {study.studyStatus === 'IN_PROGRESS' ? '진행중' : 
                                 study.studyStatus === 'COMPLETED' ? '완료' :
                                 study.studyStatus === 'APPROVED' ? '모집중' :
                                 study.studyStatus === 'TERMINATED' ? '종료' : study.studyStatus}
                              </span>
                            )}
                          </h4>
                          <p className="study-meta">참여일: {new Date(study.joinedAt).toLocaleDateString()}</p>
                          <p className="study-meta">출석률: {study.attendanceRate == null ? 'N/A' : `${study.attendanceRate}%`}</p>
                          {study.studyStatus === 'COMPLETED' ? (
                            <p className="study-action">→ 리뷰 관리</p>
                          ) : (
                            <p className="study-action">→ 관리 페이지로 이동</p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <Link to="/study" className="view-all-link">모든 스터디 보기</Link>
              </>
            )}
          </section>
        )}

        {/* 게임 활동 탭 콘텐츠 */}
        {activeTab === 'game' && (
        <section className="game-section">
          <h2>게임 활동</h2>
          
          {gameActivities.length > 0 ? (
            <>
              {/* 전체 요약 통계 */}
              {gameSummary.totalGames > 0 && (
                <div className="game-summary">
                  <div className="summary-item">
                    <span className="summary-label">총 게임 횟수</span>
                    <span className="summary-value">{gameSummary.totalGames}회</span>
                  </div>
                  {gameSummary.totalWins > 0 && (
                    <div className="summary-item">
                      <span className="summary-label">총 승리</span>
                      <span className="summary-value">{gameSummary.totalWins}회</span>
                    </div>
                  )}
                  {gameSummary.favoriteGame && (
                    <div className="summary-item">
                      <span className="summary-label">즐겨하는 게임</span>
                      <span className="summary-value">{gameSummary.favoriteGame}</span>
                    </div>
                  )}
                </div>
              )}
              
              <div className="game-cards">
                {gameActivities.map((activity, index) => (
                  <div key={index} className="game-card">
                    <div className="game-header">
                      <h3>{activity.name}</h3>
                      {activity.lastPlayed && (
                        <span className="last-played">마지막 플레이: {activity.lastPlayed}</span>
                      )}
                    </div>
                    <div className="game-stats">
                      <div className="stat-item">
                        <span className="stat-label">플레이 횟수</span>
                        <span className="stat-value">{activity.totalCount}회</span>
                      </div>
                      {activity.myRanking && activity.totalRanking && (
                        <div className="stat-item">
                          <span className="stat-label">랭킹</span>
                          <span className="stat-value ranking">
                            {activity.myRanking}위 / {activity.totalRanking}명
                          </span>
                        </div>
                      )}
                      {activity.wins !== undefined && activity.participations !== undefined && (
                        <div className="stat-item">
                          <span className="stat-label">승률</span>
                          <span className="stat-value">
                            {activity.participations > 0 
                              ? Math.round((activity.wins / activity.participations) * 100) 
                              : 0}%
                          </span>
                        </div>
                      )}
                      {activity.myRanking && !activity.totalRanking && (
                        <div className="stat-item">
                          <span className="stat-label">최고 점수</span>
                          <span className="stat-value">{activity.myRanking}점</span>
                        </div>
                      )}
                    </div>
                    <Link to={activity.link} className="play-button">
                      게임하러 가기
                    </Link>
                  </div>
                ))}
              </div>
            </>
          ) : (
            <div className="empty-state">
              <p>아직 플레이한 게임이 없어요</p>
              <p>스터디 쉬는 시간에 재미있는 게임 한 판 어떠세요?</p>
              <Link to="/lab" className="browse-button">게임 둘러보기</Link>
            </div>
          )}
        </section>
        )}
        </div>
      </div>

      {/* 설정 섹션 */}
      <section className="settings-section">
        <h3>설정</h3>
        <nav className="settings-nav">
          <Link to="/users/me/edit">프로필 수정</Link>
          <a href="#" onClick={(e) => { e.preventDefault(); setShowPasswordModal(true); }}>비밀번호 변경</a>
          <a href="#" onClick={(e) => { e.preventDefault(); setShowLogoutModal(true); }}>로그아웃</a>
        </nav>
      </section>

      {/* 하단 격려 메시지 */}
      <div className="motivation-message">
        <p>오늘도 열공하세요!</p>
      </div>
      </div>
      )}
      
      {/* 모달 컴포넌트들 */}
      <PasswordChangeModal 
        isOpen={showPasswordModal} 
        onClose={() => setShowPasswordModal(false)} 
      />
      <LogoutConfirmModal 
        isOpen={showLogoutModal} 
        onClose={() => setShowLogoutModal(false)} 
      />
    </div>
  );
}

export default ProfilePage;