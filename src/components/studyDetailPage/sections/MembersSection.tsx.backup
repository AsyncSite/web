import React, { useState, useEffect } from 'react';
import './MembersSection.css';
import './MembersSection-tecoteco.css';
import {
  MemberProfile, 
  MemberCardTheme, 
  MemberLayoutType,
  MembersSectionData 
} from '../types/memberTypes';
import { fetchAndMergeMembersData } from '../utils/membersDataFetcher';

interface MembersSectionProps {
  data: MembersSectionData;
  studyId?: string; // Optional studyId to fetch real member data
}

// ê°œë³„ ë©¤ë²„ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
const MemberCard: React.FC<{
  member: MemberProfile;
  theme: MemberCardTheme;
  onClick?: () => void;
  // tecoteco ì „ìš© ìƒí˜¸ì‘ìš© ì§€ì›
  onHoverChange?: (hovered: boolean) => void;
  hoveredActiveName?: string | null;
  isMvpHint?: boolean;
}> = ({ member, theme, onClick, onHoverChange, hoveredActiveName, isMvpHint }) => {
  const [isHovered, setIsHovered] = useState(false);
  const [hoverPos, setHoverPos] = useState<{x:number; y:number}>({ x: 0, y: 0 });
  
  // ê¸°ë³¸ ì´ë¯¸ì§€ ì²˜ë¦¬
  const handleImageError = (e: React.SyntheticEvent<HTMLImageElement>) => {
    e.currentTarget.src = '/images/default-avatar.png';
  };
  
  // ê°€ì… ê¸°ê°„ ê³„ì‚°
  const getMemberDuration = (joinDate?: string): string => {
    if (!joinDate) return '';
    const joined = new Date(joinDate);
    const today = new Date();
    const months = (today.getFullYear() - joined.getFullYear()) * 12 + today.getMonth() - joined.getMonth();
    // tecoteco ì¹´ë“œ í‘œê¸°ì™€ ë™ì¼: "í•¨ê»˜í•œ ì§€ Nê°œì›”"
    if (theme === 'tecoteco') return `í•¨ê»˜í•œ ì§€ ${months}ê°œì›”`;
    // ê¸°ë³¸ í‘œê¸°
    if (months === 0) return 'ì´ë²ˆ ë‹¬ í•©ë¥˜';
    if (months === 1) return '1ê°œì›”ì§¸';
    return `${months}ê°œì›”ì§¸`;
  };
  
  const isBlurred = !!hoveredActiveName && hoveredActiveName !== member.name;

  return (
    <div 
      className={`${theme === 'tecoteco' ? 'tecoteco-contributor-card' : 'member-card member-card-' + theme} ${isHovered ? 'hovered' : ''} ${isBlurred ? 'blurred' : ''} ${isMvpHint ? 'mvp-card' : ''}`}
      onClick={onClick}
      onMouseEnter={(e) => { setIsHovered(true); onHoverChange?.(true); setHoverPos({ x: e.clientX, y: e.clientY }); }}
      onMouseMove={(e) => { if (isHovered) setHoverPos({ x: e.clientX, y: e.clientY }); }}
      onMouseLeave={() => { setIsHovered(false); onHoverChange?.(false); }}
    >
      {/* MVP ë°°ì§€ (í…Œì½”í…Œì½” í…Œë§ˆ) */}
      {theme === 'tecoteco' && (isMvpHint || (member.badges && member.badges.some(b => b.type === 'mvp'))) && (
        <div className="mvp-badge">ğŸ‘‘ ì´ì£¼ì˜ MVP</div>
      )}
      {/* ì¼ë°˜ ë°°ì§€ í‘œì‹œ */}
      {theme !== 'tecoteco' && member.badges && member.badges.length > 0 && (
        <div className="member-badges">
          {member.badges.map((badge, idx) => (
            <span key={idx} className={`badge badge-${badge.type}`}>
              {badge.icon} {badge.label}
            </span>
          ))}
        </div>
      )}
      
      {/* í”„ë¡œí•„ ì´ë¯¸ì§€ */}
      <div className={theme === 'tecoteco' ? 'tecoteco-profile-wrapper' : 'member-image-wrapper'}>
        <img 
          src={member.imageUrl || '/images/default-avatar.png'} 
          alt={member.name}
          onError={handleImageError}
          className={theme === 'tecoteco' ? 'tecoteco-profile-img' : 'member-image'}
        />
        {member.isActive && <div className="activity-indicator" />}
      </div>
      
      {/* ê¸°ë³¸ ì •ë³´ */}
      <h3 className={theme === 'tecoteco' ? 'tecoteco-contributor-name' : 'member-name'}>{member.name}</h3>
      {theme !== 'tecoteco' && (
        <p className="member-role">{member.role}</p>
      )}
      
      {/* ê°€ì… ê¸°ê°„ */}
      {member.joinDate && (
        <p className={theme === 'tecoteco' ? 'tecoteco-contributor-duration' : 'member-duration'}>{getMemberDuration(member.joinDate)}</p>
      )}
      
      {/* í•œ ì¤„ ì†Œê°œ */}
      {member.tagline && (
        <p className={theme === 'tecoteco' ? 'tecoteco-contributor-contribution' : 'member-tagline'}>
          {member.tagline}
        </p>
      )}
      
      {/* ì»¤ìŠ¤í…€ í•„ë“œ */}
      {theme !== 'tecoteco' && member.customFields && member.customFields.length > 0 && (
        <div className="member-custom-fields">
          {member.customFields.map((field, idx) => (
            <div key={idx} className="custom-field">
              <span className="field-icon">{field.icon}</span>
              <span className="field-label">{field.label}:</span>
              <span className="field-value">{field.value}</span>
            </div>
          ))}
        </div>
      )}

      {/* tecoteco ë¯¸ë‹ˆ í†µê³„ í”„ë¦¬ë·° (streak) */}
      {theme === 'tecoteco' && typeof member.streak === 'number' && (
        <div className="member-stats-preview">
          <span className="streak-preview">ğŸ”¥ {member.streak}</span>
        </div>
      )}
      
      {/* í˜¸ë²„ ì‹œ ì¶”ê°€ ì •ë³´ (modern í…Œë§ˆ) */}
      {theme === 'modern' && isHovered && (
        <div className="member-hover-info">
          {member.achievement && (
            <div className="hover-achievement">
              <strong>ì„±ê³¼</strong>
              <p>{member.achievement}</p>
            </div>
          )}
          {member.message && (
            <div className="hover-message">
              <p>"{member.message}"</p>
              {member.messageFrom && (
                <span className="message-from">- {member.messageFrom}</span>
              )}
            </div>
          )}
          <div className="hover-cta">ìì„¸íˆ ë³´ê¸° â†’</div>
        </div>
      )}
      {/* tecoteco ì „ìš©: í˜¸ë²„ ë””í…Œì¼(í™”ë©´ ì¤‘ì•™ ê³ ì •) */}
      {theme === 'tecoteco' && isHovered && (
        <div className="hover-detail-overlay">
          <div className="hover-detail-popup">
            <div className="hover-detail-header">
              <span className="hover-detail-role">{member.role}</span>
              <span className="hover-detail-streak">ğŸ”¥ {(() => {
                return typeof member.streak === 'number' ? member.streak : '';
              })()}ì¼ ì—°ì†</span>
            </div>
            {member.memorableProblem && (
              <div className="hover-detail-problem">
                <strong>ìµœê·¼ ë„ì „í•œ ë¬¸ì œ</strong>
                {member.memorableProblem.split(' - ')[1] || member.memorableProblem}
              </div>
            )}
            {member.testimonial && (
              <div className="hover-detail-testimonial">"{member.testimonial}"</div>
            )}
            <div className="hover-detail-footer">í´ë¦­í•´ì„œ ë” ìì„¸í•œ ì´ì•¼ê¸° ë³´ê¸° â†’</div>
          </div>
        </div>
      )}
      
      {/* ë ˆê±°ì‹œ bio ì§€ì› */}
      {!member.tagline && member.bio && (
        <p className="member-bio">{member.bio}</p>
      )}
    </div>
  );
};

// ë©¤ë²„ ìƒì„¸ ëª¨ë‹¬
const MemberDetailModal: React.FC<{
  member: MemberProfile;
  isOpen: boolean;
  onClose: () => void;
}> = ({ member, isOpen, onClose }) => {
  
  React.useEffect(() => {
    const handleEscKey = (event: KeyboardEvent) => {
      if (event.key === 'Escape') {
        onClose();
      }
    };
    
    if (isOpen) {
      document.addEventListener('keydown', handleEscKey);
      document.body.style.overflow = 'hidden';
    }
    
    return () => {
      document.removeEventListener('keydown', handleEscKey);
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, onClose]);
  
  if (!isOpen) return null;
  
  return (
    <div className="member-modal-overlay" onClick={onClose}>
      <div className="member-modal-content" onClick={(e) => e.stopPropagation()}>
        <button className="modal-close-btn" onClick={onClose}>Ã—</button>
        
        <div className="modal-header">
          <img 
            src={member.imageUrl || '/images/default-avatar.png'} 
            alt={member.name}
            className="modal-profile-img"
          />
          <div className="modal-member-info">
            <h3>{member.name}</h3>
            <span className="modal-role">{member.role}</span>
            {member.recentActivity && (
              <span className="modal-recent-activity">{member.recentActivity}</span>
            )}
            {member.currentFocus && (
              <span className="modal-current-focus">ğŸ“š {member.currentFocus}</span>
            )}
            <div className="modal-stats">
              {typeof member.streak === 'number' && member.streak > 0 && (
                <span className="modal-streak">ğŸ”¥ {member.streak}ì¼ ì—°ì†</span>
              )}
              {typeof member.solvedProblems === 'number' && member.solvedProblems > 0 && (
                <span className="modal-solved">âœ… {member.solvedProblems}ë¬¸ì œ</span>
              )}
            </div>
          </div>
        </div>
        
        <div className="modal-content-sections">
          {member.memorableProblem && (
            <div className="modal-section">
              <h4>ğŸ† ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ë¬¸ì œ</h4>
              <p className="modal-problem">{member.memorableProblem}</p>
            </div>
          )}
          
          {member.whatIGained && (
            <div className="modal-section">
              <h4>ğŸ’¡ í…Œì½”í…Œì½”ì—ì„œ ì–»ì€ ê²ƒ</h4>
              <p className="modal-gained">{member.whatIGained}</p>
            </div>
          )}
          
          {member.testimonial && (
            <div className="modal-section">
              <h4>ğŸ’¬ ë™ë£Œì˜ í•œë§ˆë””</h4>
              <p className="modal-testimonial">"{member.testimonial}"</p>
              {member.from && (
                <span className="testimonial-author">- {member.from}</span>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// í†µê³„ ì„¹ì…˜
const StatsSection: React.FC<{ stats: any }> = ({ stats }) => {
  if (!stats) return null;
  
  return (
    <div className="members-stats-container">
      <h3 className="stats-title">ìš°ë¦¬ì˜ ì—¬ì •</h3>
      <div className="stats-grid">
        {stats.totalMembers && (
          <div className="stat-item">
            <span className="stat-number">{stats.totalMembers}</span>
            <span className="stat-label">ì „ì²´ ë©¤ë²„</span>
          </div>
        )}
        {stats.activeMembers && (
          <div className="stat-item">
            <span className="stat-number">{stats.activeMembers}</span>
            <span className="stat-label">í™œë™ ë©¤ë²„</span>
          </div>
        )}
        {stats.totalHours && (
          <div className="stat-item">
            <span className="stat-number">{stats.totalHours}ì‹œê°„</span>
            <span className="stat-label">í•¨ê»˜í•œ ì‹œê°„</span>
          </div>
        )}
        {stats.customStats && stats.customStats.map((stat: any, idx: number) => (
          <div key={idx} className="stat-item">
            {stat.icon && <span className="stat-icon">{stat.icon}</span>}
            <span className="stat-number">{stat.value}</span>
            <span className="stat-label">{stat.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

// ë©”ì¸ MembersSection ì»´í¬ë„ŒíŠ¸
const MembersSection: React.FC<MembersSectionProps> = ({ data, studyId }) => {
  const { 
    members: initialMembers = [], 
    title = 'í•¨ê»˜í•˜ëŠ” ì‚¬ëŒë“¤',
    subtitle,
    theme = 'classic',
    layout = 'grid',
    showStats = false,
    stats
  } = data;
  
  const [members, setMembers] = useState<MemberProfile[]>(initialMembers);
  const [selectedMember, setSelectedMember] = useState<MemberProfile | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isLoadingMembers, setIsLoadingMembers] = useState(false);
  // tecoteco í…Œë§ˆì—ì„œ ì‚¬ìš©ë  stateë“¤ì„ ë¯¸ë¦¬ ì„ ì–¸ (ì¡°ê±´ë¶€ hooks ì—ëŸ¬ ë°©ì§€)
  const [hoveredName, setHoveredName] = useState<string | null>(null);
  const [hoveredMember, setHoveredMember] = useState<MemberProfile | null>(null);
  
  // Fetch real member data when studyId is provided
  useEffect(() => {
    const loadMemberData = async () => {
      if (!studyId) {
        // No studyId, use initial members as-is
        setMembers(initialMembers);
        return;
      }
      
      setIsLoadingMembers(true);
      try {
        const mergedMembers = await fetchAndMergeMembersData(studyId, initialMembers);
        setMembers(mergedMembers);
      } catch (error) {
        console.error('Failed to fetch member data:', error);
        // Fallback to initial members
        setMembers(initialMembers);
      } finally {
        setIsLoadingMembers(false);
      }
    };
    
    loadMemberData();
  }, [studyId, initialMembers]);
  
  if (members.length === 0 && !isLoadingMembers) {
    return null;
  }
  
  // Show loading state while fetching real member data
  if (isLoadingMembers) {
    return (
      <div className={`study-detail-members-section theme-${theme}`}>
        <div className="members-container">
          <div className="members-header">
            {title && <h2 className="members-title">{title}</h2>}
            {subtitle && <p className="members-subtitle">{subtitle}</p>}
          </div>
          <div style={{ textAlign: 'center', padding: '40px', color: '#888' }}>
            ë©¤ë²„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>
    );
  }
  
  const handleMemberClick = (member: MemberProfile) => {
    setSelectedMember(member);
    setIsModalOpen(true);
  };
  
  const closeModal = () => {
    setIsModalOpen(false);
    setSelectedMember(null);
  };
  
  // tecoteco í…Œë§ˆì¼ ë•ŒëŠ” í•˜ë“œì½”ë”© í˜ì´ì§€ì™€ ë™ì¼í•œ DOM êµ¬ì¡°/í´ë˜ìŠ¤ ì¼ë¶€ë¥¼ ì¬í˜„
  if (theme === 'tecoteco') {
    const weeklyMvpName = data.weeklyMvp;
    // hoveredNameê³¼ hoveredMemberëŠ” ì´ë¯¸ ì»´í¬ë„ŒíŠ¸ ìƒë‹¨ì—ì„œ ì„ ì–¸ë¨
    return (
      <section className={`study-detail-members-section theme-tecoteco tecoteco-members-section`}>
        {/* íƒœê·¸ í—¤ë” ë° íƒ€ì´í‹€ (ì¢Œì¸¡ ì •ë ¬) */}
        <div className="section-tag-header">í•¨ê»˜í•˜ëŠ” ë©¤ë²„ë“¤ì´ì—ìš”</div>
        <h2 className="section-title">ë” ë©‹ì§„ ì—¬ì •ì´ í¼ì³ì§ˆ ê±°ì˜ˆìš”, <br /> í•¨ê»˜ë¼ë©´.</h2>

        {/* ë©¤ë²„ ì¹´ë“œ ìºëŸ¬ì…€: ë‘ ë²ˆ ë Œë”ë§í•˜ì—¬ ë¬´í•œ ìŠ¤í¬ë¡¤ íš¨ê³¼ */}
        <div className="scrolling-members-wrapper">
          <div className="scrolling-members-inner">
            <div className="tecoteco-contributors-list">
              {members.map((member, index) => (
                <MemberCard
                  key={index}
                  member={member}
                  theme={theme}
                  onClick={() => handleMemberClick(member)}
                  onHoverChange={(h) => {
                    setHoveredName(h ? member.name : null);
                    setHoveredMember(h ? member : null);
                  }}
                  hoveredActiveName={hoveredName}
                  isMvpHint={weeklyMvpName ? member.name === weeklyMvpName : false}
                />
              ))}
            </div>
            <div className="tecoteco-contributors-list" aria-hidden="true">
              {members.map((member, index) => (
                <MemberCard
                  key={`duplicate-${index}`}
                  member={member}
                  theme={theme}
                  onClick={() => handleMemberClick(member)}
                  onHoverChange={(h) => {
                    setHoveredName(h ? member.name : null);
                    setHoveredMember(h ? member : null);
                  }}
                  hoveredActiveName={hoveredName}
                  isMvpHint={weeklyMvpName ? member.name === weeklyMvpName : false}
                />
              ))}
            </div>
          </div>
        </div>

        {/* ì¸í„°ë™ì…˜ íŒíŠ¸ */}
        <p className="members-intro">
          ê°ìì˜ ì„±ì¥ ìŠ¤í† ë¦¬ê°€ ëª¨ì—¬ ë” í° ì‹œë„ˆì§€ë¥¼ ë§Œë“¤ì–´ê°€ê³  ìˆì–´ìš”.
          <br />
          <span className="interactive-hint">ğŸ’¡ ë©¤ë²„ ì¹´ë“œë¥¼ í´ë¦­í•´ì„œ ë” ìì„¸í•œ ì´ì•¼ê¸°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</span>
        </p>

        {/* ì—°ê²°ì„± ì¥ì‹ ë¼ì¸ */}
        <div className="connection-lines">
          <svg className="connections-svg" viewBox="0 0 100 20">
            <path
              d="M 10 10 Q 30 5 50 10 T 90 10"
              className="connection-path"
              stroke="rgba(195, 232, 141, 0.3)"
              strokeWidth="1"
              fill="none"
            />
          </svg>
          <span className="connection-text">ì„œë¡œ ì˜ê°ì„ ì£¼ê³ ë°›ìœ¼ë©°</span>
        </div>

        {/* í†µê³„ ì„¹ì…˜ (í…Œì½”í…Œì½” ìŠ¤íƒ€ì¼) */}
        {showStats && stats && (
          <div className="stats-container">
            <h3 className="stats-title">í•œë•€ í•œë•€ ìŒ“ì¸ ì‘ì§€ë§Œ í™•ì‹¤í•œ ì„±ì·¨ë“¤</h3>
            <div className="stats-grid">
              {stats.totalProblems && (
                <div className="stat-item">
                  <span className="stat-number">{stats.totalProblems.toLocaleString()}</span>
                  <span className="stat-label">ì´ í•´ê²°í•œ ë¬¸ì œ</span>
                </div>
              )}
              {stats.totalHours && (
                <div className="stat-item">
                  <span className="stat-number">{stats.totalHours}ì‹œê°„+</span>
                  <span className="stat-label">í•¨ê»˜í•œ ì‹œê°„</span>
                </div>
              )}
              {stats.participationRate && (
                <div className="stat-item">
                  <span className="stat-number">{stats.participationRate}%</span>
                  <span className="stat-label">í‰ê·  ì°¸ì—¬ìœ¨</span>
                </div>
              )}
              {Array.isArray(stats.popularAlgorithms) && (
                <div className="stat-item popular-algorithms">
                  <span className="stat-label">ì¸ê¸° ì•Œê³ ë¦¬ì¦˜</span>
                  <div className="algorithm-tags">
                    {stats.popularAlgorithms.map((algo, index) => (
                      <span key={index} className="algorithm-tag">{algo}</span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* í˜¸ë²„ ë””í…Œì¼ì€ ê° ì¹´ë“œì—ì„œ ì²˜ë¦¬ë¨ */}

        {/* ë©¤ë²„ ìƒì„¸ ëª¨ë‹¬ */}
        {selectedMember && (
          <MemberDetailModal
            member={selectedMember}
            isOpen={isModalOpen}
            onClose={closeModal}
          />
        )}
      </section>
    );
  }

  return (
    <div className={`study-detail-members-section theme-${theme}`}>
      <div className="members-container">
        {/* í—¤ë” */}
        <div className="members-header">
          {title && <h2 className="members-title">{title}</h2>}
          {subtitle && <p className="members-subtitle">{subtitle}</p>}
        </div>
        
        {/* ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ */}
        <div className={`members-layout layout-${layout}`}>
          {layout === 'carousel' ? (
            <div className="members-carousel">
              <div className={`carousel-track ${members.length < 4 ? 'no-animation' : ''}`}>
                {members.map((member, index) => (
                  <MemberCard
                    key={index}
                    member={member}
                    theme={theme}
                    onClick={() => handleMemberClick(member)}
                  />
                ))}
                {/* ë¬´í•œ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ë³µì œ - ë©¤ë²„ê°€ 4ëª… ì´ìƒì¼ ë•Œë§Œ */}
                {members.length >= 4 && members.map((member, index) => (
                  <MemberCard
                    key={`duplicate-${index}`}
                    member={member}
                    theme={theme}
                    onClick={() => handleMemberClick(member)}
                  />
                ))}
              </div>
            </div>
          ) : (
            <div className={`members-${layout}`}>
              {members.map((member, index) => (
                <MemberCard
                  key={index}
                  member={member}
                  theme={theme}
                  onClick={() => handleMemberClick(member)}
                />
              ))}
            </div>
          )}
        </div>
        
        {/* ì¸í„°ë™ì…˜ íŒíŠ¸ */}
        {theme === 'modern' && (
          <p className="members-interaction-hint">
            ğŸ’¡ ë©¤ë²„ ì¹´ë“œë¥¼ í´ë¦­í•´ì„œ ë” ìì„¸í•œ ì´ì•¼ê¸°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
          </p>
        )}
        
        {/* í†µê³„ ì„¹ì…˜ */}
        {showStats && stats && <StatsSection stats={stats} />}
        
        {/* ë©¤ë²„ ìƒì„¸ ëª¨ë‹¬ */}
        {selectedMember && (
          <MemberDetailModal
            member={selectedMember}
            isOpen={isModalOpen}
            onClose={closeModal}
          />
        )}
      </div>
    </div>
  );
};

export default MembersSection;